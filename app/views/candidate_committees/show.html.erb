<p id="notice"><%= notice %></p>

 <% if user_signed_in? && current_user.admin? && Admin.last.admin_mode == true %>

<h5>Import Transactions</h5>
    <%= form_tag import_transactions_path(:candidate_committee_id => @candidate_committee.id), multipart: true do %>
    <%= file_field_tag :file %>
    <%= submit_tag "Import" %>
    <%end%>
<br>
<% if @candidate_committee.imports.present? %>
<table class="table">
  <thead>
    <tr>
    <th>ID</th>
      <th>Created At</th>
      <th># of Transactions</th>
      <th>Begins</th>
      <th>Ends</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  <% @candidate_committee.imports.each do |import| %>
    <tr>
      
      <% if import.transactions.present? %>
      <td><%=import.id%></td>
      <td><%=import.created_at %></td>
      <td><%=import.transactions.count %></td>
      <td><%= import.transactions.order('transaction_date desc').last.transaction_date %></td>
      <td><%= import.transactions.order('transaction_date desc').first.transaction_date %></td>
      <td><%= link_to 'Destroy', import, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      <%end%>
     
    </tr>
     <%end%>
  </tbody>
</table>
<%end%>
<%end%>

<h1><%= @candidate_committee.name %></h1>



<p>
  <strong>Committee for:</strong>
  <%= link_to "#{@candidate_committee.person.full_name}", @candidate_committee.person %>
</p>

<h4>Reports</h4>
   
        
        <div class="card mb-3 bg-white rounded ">
        <div class="table-responsive">
            <table class="table table-sm bg-white p-4" >
            <thead >
                <tr class="card-header">
                <th></th>
                <th class="col-2 text-right">Raised</th>
                <th class="col-2 text-right pr-4">Spent </th>
                <th class="col-1 text-right d-none d-lg-table-cell">Debt</th>
                <th class="col-2 text-right pr-4 d-none d-lg-table-cell">Cash on Hand</th>
        
                </tr>

                <tr >
                <th class="pl-4">Committee Totals<%if user_signed_in? && current_user.admin?%> - <%= link_to "Add Report", new_report_path(:candidate_committee_id => @candidate_committee.id), 
                    :class => "", :action => "new", :method => :get %><%end%></th>
                <th class="text-right"><%= number_to_currency(@candidate_committee.reports.sum(:period_receipts)) %><%if @candidate_committee.reports.present?%><br><small>Loans: <%= number_to_currency(@candidate_committee.reports.sum(:loans_received)) %></small><%end%></th>
                <th class="text-right pr-4"><%= number_to_currency(@candidate_committee.reports.sum(:period_disbursements)) %></th>
                <th class="text-right d-none d-lg-table-cell"><%if @candidate_committee.reports.present?%><%= number_to_currency(@candidate_committee.reports.order('period_end DESC').first.current_debt) %><%else%>$0.00<%end%></th>
                <th class="text-right pr-4 d-none d-lg-table-cell"><%if @candidate_committee.reports.present?%><%= number_to_currency(@candidate_committee.reports.order('period_end DESC').first.current_coh) %><br><small>Net: <%= number_to_currency(@candidate_committee.reports.order('period_end DESC').first.net_coh) %></small><%else%>$0.00<%end%></th>

                </tr>
            </thead>
            
            <tbody>
                <%if @candidate_committee.reports.present?%>
                    <% @candidate_committee.reports.order('period_end DESC').each do |report| %>
                        <tr>
                            <td class="pl-4 d-none d-lg-table-cell"><%= link_to "#{report.period_begin.strftime("%b %d, %Y")} - #{report.period_end.strftime("%b %d, %Y")}", report %></td>
                            <td class="pl-4 d-lg-none"><%= link_to "#{report.period_begin.strftime("%m/%d/%y")} - #{report.period_end.strftime("%m/%d/%y")}", report %></td>
                            <td class="text-right "><%= number_to_currency(report.period_receipts) %></td>
                            <td class="text-right pr-4"><%= number_to_currency(report.period_disbursements) %></td>
                            <td class="text-right d-none d-lg-table-cell"><%= number_to_currency(report.current_debt) %></td>
                            <td class="text-right d-none d-lg-table-cell pr-4"><%= number_to_currency(report.current_coh) %></td>
                        </tr>
                    <%end%>  
                <%else%>
                <tr>
                <td class="pl-4">No reports filed yet. </td> 
                </tr>
                <%end%>
            </tbody>
        </table>
        </div>
        </div>
    

<% if @candidate_committee.self_fund.count > 0 %>
  <div class="card">
    <div class="card-header" style="max-width: 100%;">Contributions/Loans from the Candidate</div>
 
        <table class="table table-sm">
          <thead>
            <tr>
              <th class="pl-4">Name</th>
              <th>Contribution Type</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            
              <% @candidate_committee.self_fund.each do |transaction| %>
              <tr>
                <td class="pl-4"><%= transaction.full_name %></td>
                <td><%= transaction.full_transaction_type %></td>
                <td><%= number_to_currency(transaction.amount) %></td>
                <td><%= transaction.transaction_date %></td>
            </tr>
            <%end%>
          </tbody>

        </table>


  </div>
<%end%>

<br>


<% if @candidate_committee.transactions.where(transaction_type: "RCPT").present?  %>

<div class="card">
  <div class="card-header" style="max-width: 100%;">Contributions to Committee</div>
  <div class="p-4">
  <table class="display table table-sm" id="">
    <thead>
      <tr>
        
        <th>Contributor</th>
        <th>Occupation</th>
        <th>Amount</th>
        <th>Date</th>
        <% if user_signed_in? %><th></th><%end%>
      </tr>
    </thead>

    <tbody>
      <% @candidate_committee.transactions.where(transaction_type: "RCPT").each do |transaction| %>
        <tr>
        
          <td><% if transaction.contributor.present? %><%= link_to "#{transaction.entity_first_name} " "#{transaction.entity_last_name}", transaction.contributor  %><%else%><%= "#{transaction.entity_first_name} " "#{transaction.entity_last_name}" %><%end%>
              <br><span class="small"><%= transaction.entity_city %>, <%= transaction.entity_state %> <%= transaction.entity_zip %></span>
          </td>
          <td><%if transaction.entity_occupation != "N/A" %><%= transaction.entity_occupation %><br><span class="small"><%= transaction.entity_employer %></span><%end%></td>
          <td><%= number_to_currency(transaction.amount) %><br><span class="small"><%=transaction.full_payment_type %></span></td>
          
          <td><%= transaction.transaction_date %></td>
          
          <% if user_signed_in? %><td><%= link_to 'Destroy', transaction, method: :delete, data: { confirm: 'Are you sure?' } %></td><%end%>
        </tr>
      <% end %>
    </tbody>
  </table>
  <br>
  <table class="table-sm table table-success">
    <thead>
      <tr>
        <th>Total Raised</th>
        <th># of Donations</th>
        <th># of Donors</th>
        <th>Avg. Donation</th>
        <th>Median Donation</th>
        <th>% of Individuals</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><%= number_to_currency(@candidate_committee.transactions.where(transaction_type: "RCPT").sum(:amount)) %></td>
         <td><%= @candidate_committee.transactions.where(transaction_type: "RCPT").count %></td>
         <td><%= @candidate_committee.transactions.where(transaction_type: "RCPT").pluck(:full_name).uniq.count %></td>
         <td><%= number_to_currency(@candidate_committee.transactions.where(transaction_type: "RCPT").average(:amount)) %></td>
         <td><%= number_to_currency(@candidate_committee.median_donation) %></td>
         <td><%= number_with_precision(@candidate_committee.individual_percentage, precision: 2) %>%</td>
         
      </tr>
    
    </tbody>
  
  </table>
  </div>
</div>
<br>
<div class="row">
  <div class="col">
        <div class="card">
  <div class="card-header" style="max-width: 100%;">Top Cities</div>
    <table class="table">
      <thead>
        <tr>
          <th>City</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        <% @candidate_committee.transactions.where(transaction_type: "RCPT").select('entity_city, sum(amount) as total').group('entity_city').order('total desc').limit(10).each do |transaction| %>
        <tr>
          <td><%= transaction.entity_city %></td>
          <td><%= number_to_currency(transaction.total) %></td>
        </tr>
        <%end%>
      </tbody>
    
    </table>
  </div>
  </div>
      <div class="col">
      <div class="card">
  <div class="card-header" style="max-width: 100%;">Top Professions</div>
      <table class="table">
      <thead>
        <tr>
          <th>Occupation</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        <% @candidate_committee.transactions.where(transaction_type: "RCPT").where.not(entity_occupation: "N/A").where.not(entity_occupation: "").select('entity_occupation, sum(amount) as total').group('entity_occupation').order('total desc').limit(10).each do |transaction| %>
        <tr>
          <td><%= transaction.entity_occupation %></td>
          <td><%= number_to_currency(transaction.total) %></td>
        </tr>
        <%end%>
      </tbody>
    
    </table>
    </div>
    </div>
    <div class="col">
      <div class="card">
  <div class="card-header" style="max-width: 100%;">Top Companies</div>
      <table class="table">
      <thead>
        <tr>
          <th>Occupation</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        <% @candidate_committee.transactions.where(transaction_type: "RCPT").where.not(entity_employer: "N/A").where.not(entity_employer: "").select('entity_employer, sum(amount) as total').group('entity_employer').order('total desc').limit(10).each do |transaction| %>
        <tr>
          <td><%= transaction.entity_employer %></td>
          <td><%= number_to_currency(transaction.total) %></td>
        </tr>
        <%end%>
      </tbody>
    
    </table>
    </div>
    </div>
</div>
<%end%>
<% if @candidate_committee.transactions.where(transaction_type: "EXPN").present? %>
<br>
<div class="card">
  <div class="card-header" style="max-width: 100%;">Expenditures</div>
  <div class="p-4">
  <table class="display table table-sm" id="">
    <thead>
      <tr>
        <th>Expense Type</th>
        <th>Recipient</th>
        <th>Amount</th>
        <th>Date</th>
        
        <% if user_signed_in? %><th></th><%end%>
      </tr>
    </thead>

    <tbody>
      <% @candidate_committee.transactions.where(transaction_type: "EXPN").each do |transaction| %>
        <tr>
          <td><%= transaction.full_expense_type %></td>
          <td><%= link_to "#{transaction.entity_first_name} " "#{transaction.entity_last_name}", transaction.vendor %> </td>
          <td><%= number_to_currency(transaction.amount) %></td>
          <td><%= transaction.transaction_date %></td>
          
          <% if user_signed_in? %><td><%= link_to 'Destroy', transaction, method: :delete, data: { confirm: 'Are you sure?' } %></td><%end%>
        </tr>
      <% end %>
    </tbody>
  </table>
  </div>
</div>

<br>
<div class="card">
  <div class="card-header" style="max-width: 100%;">Campaign Expense Categories</div>
    <table class="table">
      <thead>
        <tr>
          <th class="pl-4">Expense Type</th>
          <th>Amount</th>
          <th>% of Spend</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @candidate_committee.transactions.where(transaction_type: "EXPN").select('expense_code, sum(amount) as total').group('expense_code').order('total desc').each do |transaction| %>
        <tr>
        
          <td class="pl-4 col-5"><%= transaction.full_expense_type %></td>
          <td class="col-1"><%= number_to_currency(transaction.total) %></td>
          <td class="col-1"><%= number_with_precision((transaction.total / @candidate_committee.total_expenditures)*100, precision: 2) %>%</td>
          <td class="col-5">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: <%= (transaction.total / @candidate_committee.total_expenditures)*100 %>%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
          </div>  
            
            
            </td>
        </tr>
        <%end%>
      </tbody>
    
    </table>

  </div>


<%end%>


<br>
<% if @candidate_committee.transactions.where(expense_code: "CTB").or(@candidate_committee.transactions.where(expense_code: "CONTRIBUTION")).present? %>
<div class="card">
  <div class="card-header" style="max-width: 100%;">List of Contributions Made</div>
  <div class="p-4">
  <table class="display table table-sm" id="">

    <thead>
      <tr>

        <th>Recipient</th>
        <th>Date</th>
        <th>Amount</th>
        <% if user_signed_in? %><th></th><%end%>
      </tr>
    </thead>

    <tbody>
      <% @candidate_committee.transactions.where(expense_code: "CTB").or(@candidate_committee.transactions.where(expense_code: "CONTRIBUTION")).each do |transaction| %>
        <tr>

          <td><%= link_to "#{transaction.entity_first_name} " "#{transaction.entity_last_name}", transaction.vendor %> </td>

          <td><%= transaction.transaction_date %></td>
          <td><%= number_to_currency(transaction.amount) %></td>
          <% if user_signed_in? %><td><%= link_to 'Destroy', transaction, method: :delete, data: { confirm: 'Are you sure?' } %></td><%end%>
        </tr>
      <% end %>
    </tbody>
  </table>
  </div>
</div>
<%end%>

<% if user_signed_in? %><%= link_to 'Edit', edit_candidate_committee_path(@candidate_committee) %> <%end%>

<script>
$(document).ready(function () {
    $('table.display').DataTable({
        order: [[2, 'desc']],
    });
});
</script>

