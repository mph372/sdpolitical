<% if user_signed_in? %>

<div class="card" style="width: 30rem;">
  <div class="card-body">
  <h5 class="card-title"><%= @person.title %> <%= @person.first_name %> <%= @person.last_name %> </h5>
  <h6 class="card-subtitle mb-2 text-muted"><%= link_to "#{@person.incumbent_district.name}", @person.incumbent_district %> - <%= @person.incumbent_district.district.to_i.ordinalize %> District</h6>
    This is some text within a card body.
  </div>    
</div>
<br>

<div class="row">
    <div class="col-auto">
    <% if @person.image_url.present? %>
    <%= image_tag @person.image.url(:headshot), alt: 'headshot' %>
    <%else%>
    <%= image_tag "no_photo_available.jpg", alt: 'No headshot available' %>
    <%end%>
    </div>
    <div class="col">
      <h4><%= @person.title %> <%= @person.first_name %> <%= @person.last_name %> 
        <% if @person.party == "Republican"%>
        (R)
        <% elsif @person.party == "Democrat"%>
        (D)
        <% elsif @person.party == "Declined to State"%>
        (DTS)
        <%end%>
        </h4>
      <% if @person.incumbent_district.present? %>
      <p>
        <strong>Represents:</strong>
        <%= link_to "#{@person.incumbent_district.jurisdiction.name}", @person.incumbent_district.jurisdiction %> - <%= link_to "#{@person.incumbent_district.name}", @person.incumbent_district %>
        <% if @person.incumbent_district.district != "At Large"%> 
          -  <%= link_to "District #{@person.incumbent_district.district}", @person.incumbent_district %> 
         <%end%>
         <br>
      <%end%>
      

      
        <strong>Born:</strong>
        <%= @person.birthdate.to_formatted_s(:long) %> (Age <%= @person.calculated_age %>) 
        <%if @person.birthplace? %>
        in <%= @person.birthplace %>
        <% end %>
        <br>
        <% if @person.is_incumbent? %>
        <strong>Profession Before Elected Office:</strong>
        <%= @person.professional_career %>
        <% else %>
        <strong>Profession:</strong>
        <%= @person.professional_career %><br>
        <%end%>
        <br>
        <strong>Prior Elected Office:</strong>
        <%= @person.prior_elected %>
        <br>
        <% if @person.is_incumbent? %>
        <% if @person.first_elected? %>
        <strong>First Elected/Appointed as <%= @person.title %>:</strong>
        <%= @person.first_elected.strftime("%B, %Y") %> (Tenure: <%= distance_of_time_in_words(Time.now.utc.to_date, @person.first_elected ) %>)
        <br>
        <%end%>
        <strong>Salary as <%= @person.title %>:</strong>
        <%= number_to_currency(@person.salary)  %>
        <br>
        <strong>Current term expires:</strong>
        <%= @person.term_expires %> <br>
        <% if @person.term?%>
        <strong>Term Limited:</strong>
        <%= @person.term %> <br>        
        <%end%>
        <% if @person.bio.present? %>
        <strong>Full Biography:</strong>
        <div>    
        <% if @person.bio.length > 250 %>
          <%= truncate(@person.bio, length: 800) %>
          <%= link_to '...Read more', '', class: "read-more-#{@person.id}" %>
          <script>
            $('.read-more-<%= @person.id %>').on('click', function(e) {
              e.preventDefault()
              $(this).parent().html('<%= escape_javascript h(@person.bio).gsub(/\n/, '</br>').html_safe %>')
            })
          </script>
        <% else %>
          <%= h(@person.bio).gsub(/\n/, '</br>').html_safe %>
        <% end %>
        
        </div>  
        <%end%>      
        </p>
        
        <div class="row">
          <div class="col-auto">
        <strong>Resides in:</strong>
          </div>
          <div class="col-auto">
            <% if @person.congressional_district != nil %>
            <%= @person.congressional_district.ordinalize %> Congressional District <br>
            <%end%>
            <% if @person.senate_district != nil %>
            <%= @person.senate_district.ordinalize %> Senate District <br>
            <%end%>
            <% if @person.assembly_district != nil %>
            <%= @person.assembly_district.ordinalize %> Assembly District<br>
            <%end%>
            <% if @person.supe_district != nil %>
            <%= @person.supe_district.ordinalize %> Supervisorial District<br>
            <%end%>
          </div>
        </div>
        <br>
        <div class="row">
          <div class="col-auto">
        <strong>Public Contact Information:</strong>
          </div>
          <div class="col-auto">
            Phone: <br>
            E-Mail: <br>
            Facebook: <br>
            Twitter: <br>
            Website: <br>
          </div>
          <div class="col-auto">
            <%= number_to_phone(@person.phone) %> <br>
            <%= mail_to @person.email %> <br>
            <%= link_to "@#{@person.facebook}", "http://www.facebook.com/" + @person.facebook %> <br>
            <%= link_to "@#{@person.twitter}", "http://www.twitter.com/" + @person.twitter %> <br>
            <%= link_to @person.official_website %>
          </div>
        </div>
        <% if @person.reports.where(incumbent_report: true).present? %>
        <br>
        <h5><u>Incumbent Campaign Finance Data</u><br></h5>
        <div class="row">
          <div class="col-auto">
        <strong>Total Raised into <%= @person.incumbent_district.name %> Committee this Cycle: </strong> <br>
        <strong>Total Expenditures from <%= @person.incumbent_district.name %> Committee this Cycle: </strong> <br>
        <strong>Current Net Cash-on-Hand in <%= @person.incumbent_district.name %> Committee: </strong> <br>
          </div>
          <div class="col">
            <%= number_to_currency(@person.reports.where(:cycle => "2020", incumbent_report: true ).sum(:period_receipts)) %> <br>
            <%= number_to_currency(@person.reports.where(:cycle => "2020", incumbent_report: true ).sum(:period_disbursements)) %> <br>
            <%= number_to_currency(@person.reports.where(incumbent_report: true).most_recent.net_coh) %> <br>
          </div>
        </div>
        <%end%>
        <br>
        <%end%>
        
    </div>
</div>

<% if @person.on_ballot? %>
        <hr>
        <h4>Candidate Information</h4>
        <div class="row">
          <div class="col-auto"> <strong>Running for: </strong> <br>
            <strong>Candidacy Status:</strong> <br>
          <% if @person.campaign_website.present? %>
          <strong>Campaign Website:</strong> <br>
          <%end%>
          <strong>Contribution Limit:</strong><br>
          
        </div>
        <div class="col">
          <% if @person.on_ballot? %>
            <%= link_to "#{@person.district.jurisdiction.name}", @person.district.jurisdiction %> - <%= link_to "#{@person.district.name}", @person.district %>
        <% if @person.district.district != "At Large"%> 
          -  <%= link_to "District #{@person.district.district}", @person.district %> 
         <%end%> <br>
        <%end%>
        <%= @person.ballot_status %><br>
        <% if @person.campaign_website.present? %>
        <%= link_to @person.campaign_website %> <br>
        <%end%>
        $<%= number_with_delimiter(@person.district.contribution_limit, delimiter: ",") %>
        <br>
        </div>
      </div>
        
        <% if @person.reports.present? %>
        <hr>
        <div class="row">
          <div class="col">
            <strong>Total Raised for <%= @person.district.name %> this Cycle: </strong> <br>
            <strong>Total Spent for <%= @person.district.name %> this Cycle: </strong> <br>
            <strong><mark>Current Net Cash-on-Hand (Cash-on-hand minus debt): </mark></strong>
          </div>
          <div class="col">
            <%= number_to_currency(@person.reports.where(:cycle => "2020", incumbent_report: false ).sum(:period_receipts)) %> <br>
            <%= number_to_currency(@person.reports.where(:cycle => "2020", incumbent_report: false).sum(:period_disbursements)) %> <br>
            <mark><%= number_to_currency(@person.reports.where(incumbent_report: [false, nil]).most_recent.net_coh ) %><br></mark>
          </div>
        </div> <%end%>
        </p>
        <% if @person.endorsed_republican? %>
        <p class="rep-text">Endorsed by the Republican Party of San Diego County</p>
        <%end%>
        <% if @person.endorsed_democrat? %>
        <p class="dem-text"><strong>Endorsed by the San Diego County Democratic Party</strong></p>
        <%end%>
      
      <hr>

      <h5>Opponents In Race for <%= "#{@person.district.name}" %></h5>
          <table class="table table-striped table-bordered">
          <thead>
              <tr>
                <th class="col-auto">Name</th>
                <th class="col-auto">Party</th>
                <th class="col-auto">Profession</th>
                <th class="col-auto">Current Net Cash on Hand</th>
              </tr>
            </thead>

            <tbody>             
              <% @person.district.candidates.each do |candidate| %>
              <tr>
                <% if candidate.on_ballot? %>
                  <% if candidate.id != @person.id %>
                  <% report = candidate.reports.most_recent %>
                  <td>
                  <% if candidate.endorsed_republican? %>
                  <span class="rep-text">&#10003</span>
                  <%elsif candidate.endorsed_democrat?%>
                  <span class="dem-text">&#10003</span>
                  <%else%>
                  <%end%>
        <%= link_to "#{candidate.first_name} #{candidate.last_name}", candidate %></td>
                  <td  class="col-auto"><%= candidate.party %></td>
                  <td  class="col-auto"><%if candidate.is_incumbent? %>
                  <%= candidate.title %>
                  <%else%>
                  <%= candidate.professional_career %></td>
                  <%end%>
                  <td  class="col-auto">$<%= number_with_delimiter(report.net_coh, :delimiter => ',') %></td>
                  <% end %>
                  <%end%>
              <% end %>
              </tr>
            </tbody>
          </table>
            <p class="small-text">(<span class="dem-text">&#10003</span> = Endorsed by SD County Democratic Party; <span class="gop-text">&#10003</span> = Endorsed by Republican Party of San Diego County)</p>
        <%end%>
            
<% if @person.reports.present? %>
<hr>
<h5>Campaign Finance Reports for <%= "#{@person.first_name} #{@person.last_name}"%></h5>
<table class="table small-table table-striped table-bordered">
<thead>
    <tr>
      <th>Office</th>
      <th>Reporting Period</th>
      <th>Date report filed</th>
      <th>Period Receipts</th>
      <th>Period Disbursements</th>
      <th>Cash-on-hand</th>
      <th>Debt</th>
    </tr>
  </thead>

  <tbody>
    <% @reports.each do |report| %>
      <tr>
        <td><% if report.incumbent_report?%>
        <%= report.incumbent_district.name %>
        <%else%>
        <%= report.district.name %>
        <%end%>
        </td>
        <td><%= "#{report.period_begin.to_formatted_s(:long)} - #{report.period_end.to_formatted_s(:long)}" %></td>
        <td><%= link_to "#{report.report_filed.to_formatted_s(:long)}", report %></td>
        <td>$ <%= number_with_delimiter(report.period_receipts, :delimiter => ',') %></td>
        <td>$ <%= number_with_delimiter(report.period_disbursements, :delimiter => ',') %></td>
        <td>$ <%= number_with_delimiter(report.current_coh, :delimiter => ',') %></td>
        <td>$ <%= number_with_delimiter(report.current_debt, :delimiter => ',') %></td>
      </tr>
    <% end %>
  </tbody>
  </table>
  <%end%>



<% if @person.expenditures.present? %>
</table>
<hr>
<h5>Related Independent Expenditures</h5>
<table class="table small-table table-striped table-bordered">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Committee</th>
      <th>Amount</th>
      <th>Support/Oppose</th>
    </tr>
  </thead>

  <tbody>
    <% @expenditures.each do |expenditure| %>
      <tr>
        <td class="<%= expenditure.is_amendment? ? 'amended' : 'not-amended' %>"><%= expenditure.expenditure_date.to_formatted_s(:long) %></td>
        <td class="<%= expenditure.is_amendment? ? 'amended' : 'not-amended' %>"><%= expenditure.description %></td>
        <td class="<%= expenditure.is_amendment? ? 'amended' : 'not-amended' %>"><%= link_to "#{expenditure.committee.name}", expenditure.committee %></td>
        <td class="<%= expenditure.is_amendment? ? 'amended' : 'not-amended' %>"><%= number_to_currency(expenditure.amount) %></td>
        <td class="<%= expenditure.is_amendment? ? 'amended' : 'not-amended' %>"><% if expenditure.is_support? %>
            Support
            <%else%>
            Oppose
            <%end%></td>
      </tr>
    <% end %>
  </tbody>
</table>
<%end%>
<% if current_user.admin? %>
<%= link_to("Add Report", new_report_path(:person_id => @person.id), :action => "new", :method => :get)%> 
 |
<%= link_to 'Edit', edit_person_path(@person)  %> |
<%= link_to 'Delete Person', @person, method: :delete, data: { confirm: 'Are you sure?' } %> |
<%end%>
<%= link_to 'Back', people_path %>

<%else %>
  <p>Please Sign Up or Sign In to view the content.</p>
  <%= link_to 'Sign up', new_user_registration_path %><br>
  <%= link_to 'Sign in', new_user_session_path %>
<% end %>
